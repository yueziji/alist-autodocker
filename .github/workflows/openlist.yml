# .github/workflows/manual-build-openlist-v4-simple.yml

name: Build Modified OpenList (with Self-Fixing Permissions)

on:
  # ä»…å…è®¸é€šè¿‡ GitHub Actions UI æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build_and_push_simple:
    name: Build and Push Self-Fixing Docker Image
    runs-on: ubuntu-latest
    permissions:
      # Docker a GCR/GHCR éœ€è¦ packages: write æƒé™
      packages: write

    steps:
      # æ­¥éª¤ 1: æ£€å‡º OpenListTeam/OpenList ä»“åº“
      - name: Checkout OpenListTeam/OpenList Repository
        uses: actions/checkout@v4
        with:
          repository: 'OpenListTeam/OpenList'
          ref: 'main'
          fetch-depth: 0

      # æ­¥éª¤ 2: è·å–ä»“åº“çš„ Commit SHAï¼Œç”¨äº Docker æ ‡ç­¾
      - name: Get Commit SHA
        id: get_sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 3: è®¾ç½® Docker å…ƒæ•°æ®ï¼Œä½¿ç”¨ Commit SHA ä½œä¸ºå”¯ä¸€æ ‡ç­¾
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: 'yueziji/testlist' # !!! è¿™é‡Œæ˜¯æ‚¨çš„é•œåƒåç§°ï¼Œä¿æŒä¸å˜
          tags: |
            type=raw,value=${{ steps.get_sha.outputs.sha }}
            type=raw,value=latest

      # æ­¥éª¤ 4: å®‰è£… Go è¯­è¨€ç¯å¢ƒ
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      # æ­¥éª¤ 5: ç¼“å­˜ Musl äº¤å‰ç¼–è¯‘å·¥å…·é“¾ä»¥åŠ å¿«æ„å»ºé€Ÿåº¦
      - name: Cache Musl
        id: cache-musl
        uses: actions/cache@v4
        with:
          path: build/musl-libs
          key: docker-musl-libs-v2

      # æ­¥éª¤ 6: å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™ä¸‹è½½ Musl åº“
      - name: Download Musl Library
        if: steps.cache-musl.outputs.cache-hit != 'true'
        run: bash build.sh prepare docker-multiplatform
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤ 7: ç¼–è¯‘æ‰€æœ‰å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Build Go Binaries (beta)
        run: |
          sed -i "s/^  OS_ARCHES=.*/  OS_ARCHES=(linux-amd64)/" build.sh
          sed -i "s/^  CGO_ARGS=.*/  CGO_ARGS=(x86_64-linux-musl-gcc)/" build.sh
          sed -i "s/^  DOCKER_ARM_ARCHES=.*/  DOCKER_ARM_ARCHES=()/" build.sh
          echo "--- Patched build.sh content ---"
          grep -C 2 "OS_ARCHES" build.sh
          echo "------------------------------"
          bash build.sh beta docker-multiplatform
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      
      - name: "ğŸ“ Modify Dockerfile for Self-Fixing Permissions"
        run: |
          echo "--- Original Dockerfile.ci content ---"
          cat Dockerfile.ci
          echo "--------------------------------------"
          
          # 1. åˆ é™¤ USER æŒ‡ä»¤ï¼Œç¡®ä¿å®¹å™¨ä»¥ root å¯åŠ¨
          sed -i '/^USER \${USER}/d' Dockerfile.ci
          
          # 2. å°† CMD æŒ‡ä»¤æ›¿æ¢ä¸ºæˆ‘ä»¬çš„è‡ªä¿®å¤å‘½ä»¤
          #    è¿™ä¸ªå‘½ä»¤ä¼šå…ˆä»¥ root èº«ä»½ chownï¼Œç„¶åé™æƒä¸º openlist ç”¨æˆ·æ‰§è¡ŒåŸå§‹çš„ entrypoint
          sed -i '/^CMD/c\CMD [ "/bin/bash", "-c", "chown -R 1001:1001 /opt/openlist/data && su openlist -c /entrypoint.sh" ]' Dockerfile.ci

          echo "--- Modified Dockerfile.ci content ---"
          cat Dockerfile.ci
          echo "--------------------------------------"

      # æ­¥éª¤ 8: è®¾ç½® QEMU å’Œ Docker Buildx
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # æ­¥éª¤ 9: ç™»å½•åˆ° DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: yueziji
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ­¥éª¤ 10: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ (ç°åœ¨ä¼šä½¿ç”¨æˆ‘ä»¬ä¿®æ”¹åçš„ Dockerfile.ci)
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          # ä½¿ç”¨å·²è¢«æˆ‘ä»¬åŠ¨æ€ä¿®æ”¹çš„ Dockerfile.ci
          file: Dockerfile.ci
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: 'linux/amd64'
          build-args: |
            BASE_IMAGE_TAG=base
